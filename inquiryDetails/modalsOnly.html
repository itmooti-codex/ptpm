<!-- Modals -->
<div>
  <!-- Create Quote Modal -->
  <div x-data="quoteModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="handleClose"
    >
      <div class="w-full max-w-lg bg-white shadow-2xl" x-transition>
        <div
          class="flex items-start justify-between border-b border-slate-200 px-6 py-4"
        >
          <div>
            <div class="text-lg font-semibold">
              Create Quote on Behalf of Serviceman?
            </div>
            <p class="mt-1 text-sm text-slate-500">
              You're creating this quote as the admin, but it will be attributed
              to:
            </p>
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="handleClose"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="space-y-4 px-6 py-5 text-sm">
          <div>
            <p
              class="text-base font-semibold"
              x-text="providerName || 'No service provider selected'"
            ></p>
            <p class="text-sm text-slate-500">
              Serviceman ID:
              <template x-if="hasProvider">
                <span
                  class="font-semibold text-sky-600"
                  x-text="providerIdDisplay"
                ></span>
              </template>
              <template x-if="!hasProvider">
                <span class="font-semibold text-rose-500">N/A</span>
              </template>
            </p>
          </div>
          <p class="text-slate-600">Do you want to proceed?</p>
          <template x-if="!hasProvider">
            <p class="text-xs font-medium text-rose-500">
              Select a service provider before creating the quote.
            </p>
          </template>
        </div>

        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 transition hover:text-slate-700"
            @click="handleClose"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="confirmAction"
            :disabled="!hasProvider || isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span>Create & Notify</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="sendQuoteModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/60 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div class="w-full max-w-2xl rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-center justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">Send Quote To:</div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-5 px-6 py-6 text-sm text-slate-700">
          <div>
            <p class="text-xs font-semibold uppercase text-slate-500">
              Quote will be sent to:
            </p>
            <div class="mt-3 space-y-3">
              <template x-if="recipients.length">
                <div class="space-y-3">
                  <template x-for="recipient in recipients" :key="recipient.id">
                    <div
                      class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3 text-sm"
                    >
                      <div class="flex items-center gap-3">
                        <svg
                          x-show="recipient.isImportant"
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4 text-amber-400"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                          />
                        </svg>
                        <div>
                          <div class="font-semibold text-slate-900">
                            <span x-text="recipient.displayName"></span>
                            <span
                              class="text-slate-500"
                              x-text="recipient.roleLabel"
                            ></span>
                          </div>
                          <div
                            class="flex flex-wrap gap-4 text-xs text-slate-500"
                          >
                            <span x-text="recipient.email || '—'"></span>
                            <span x-text="recipient.phone || '—'"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
              <p
                class="rounded-lg border border-dashed border-slate-300 bg-slate-50 p-4 text-center text-sm text-slate-500"
                x-show="!recipients.length"
              >
                No recipients selected.
              </p>
            </div>
          </div>
          <div
            class="rounded-xl border border-slate-100 bg-slate-50 px-4 py-3 text-xs text-slate-500"
          >
            <div class="flex items-start gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="mt-0.5 h-4 w-4 text-sky-600"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.993.883L9 8v4a1 1 0 00.883.993L10 13h.01a1 1 0 00.99-.857L11 12V8a1 1 0 00-1-1zm.001 6a1 1 0 100 2 1 1 0 000-2z"
                  clip-rule="evenodd"
                />
              </svg>
              <p>
                Once this quote is sent, it requires approval from the client
                before it can proceed to the job section.
              </p>
            </div>
          </div>
        </div>
        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 hover:text-slate-700"
            @click="close"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleSend"
            :disabled="!recipients.length || isSending"
          >
            <svg
              x-show="isSending"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span x-text="isSending ? 'Sending…' : 'Send Quote'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="acceptQuoteModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/60 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div class="w-full max-w-xl rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-center justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">Accept Quote</div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-4 px-6 py-6 text-sm text-slate-700">
          <p>
            By accepting this quote, you are also agreeing to accept it on
            behalf of the
            <span class="font-semibold"
              >client (<span x-text="clientName"></span>)</span
            >
            and the
            <span class="font-semibold"
              >allocated serviceman (<span x-text="providerName"></span>)</span
            >.
          </p>
          <p>Are you sure you wish to proceed?</p>
        </div>
        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 hover:text-slate-700"
            @click="close"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleAccept"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span x-text="isSubmitting ? 'Accepting…' : 'Accept Quote'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="viewActivitiesModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/60 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div
        class="w-full max-w-5xl overflow-hidden rounded-sm bg-white shadow-2xl"
      >
        <div
          class="flex items-center justify-between bg-[#003882] px-6 py-4 text-white"
        >
          <div class="text-lg font-semibold">Activity List</div>
          <button
            class="text-white/80 transition hover:text-white"
            @click="close"
          >
            <span class="sr-only">Close</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="bg-white px-4 pb-4 pt-3">
          <div
            class="overflow-x-auto rounded-sm border border-slate-200"
            data-dynamic-list="rr3P1BMGRVVFDRr5aVY3s"
            data-entity="peterpm"
            data-var-jobid="[jobid]"
            data-op="subscribe"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-table="true"
          ></div>
        </div>

        <div class="flex justify-end border-t border-slate-200 px-6 py-4">
          <button
            class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50"
            @click="close"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="billingSummaryModal()" x-cloak>
    <div
      class="fixed inset-0 z-[400] flex items-center justify-center bg-slate-900/60 px-4 py-10 text-slate-800 hover:!bg-slate-900/60 active:!bg-slate-900/60 hover:!text-slate-800 active:!text-slate-800 hover:bg-slate-900/60 active:bg-slate-900/60 focus:bg-slate-900/60 focus-visible:bg-slate-900/60 hover:text-slate-800 active:text-slate-800 focus:text-slate-800 focus-visible:text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div
        x-ref="billingSummaryCard"
        class="relative w-full max-w-4xl max-h-[90vh] overflow-auto rounded-2xl bg-white shadow-2xl hover:!bg-white active:!bg-white hover:bg-white active:bg-white focus:bg-white focus-visible:bg-white hover:shadow-2xl active:shadow-2xl focus:shadow-2xl focus-visible:shadow-2xl flex flex-col"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b hover:border-b active:border-b focus:border-b focus-visible:border-b"
        >
          <div>
            <p
              class="text-lg font-semibold text-slate-900 hover:!text-slate-900 active:!text-slate-900 hover:text-lg active:text-lg focus:text-lg focus-visible:text-lg hover:text-slate-900 active:text-slate-900 focus:text-slate-900 focus-visible:text-slate-900"
            >
              Billing Summary
            </p>
            <p
              class="text-sm text-slate-600 hover:!text-slate-600 active:!text-slate-600 hover:text-slate-600 active:text-slate-600 focus:text-slate-600 focus-visible:text-slate-600"
              x-text="summary.businessName"
            ></p>
          </div>
        </div>

        <div class="px-6 py-6 space-y-6 flex-1 min-h-0 overflow-y-auto">
          <div
            data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
            data-var-jobid="[jobid]"
            data-entity="peterpm"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-bill-approved="[Bill_Approved_Admin]"
            class="flex flex-wrap items-center justify-between gap-3 text-sm text-slate-600 hover:!text-slate-600 active:!text-slate-600 hover:text-slate-600 active:text-slate-600 focus:text-slate-600 focus-visible:text-slate-600"
          >
            <div>
              <span
                class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Job ID:</span
              >
              <a
                class="font-semibold text-sky-700 hover:!underline hover:!text-sky-700 active:!text-sky-700 hover:text-sky-700 active:text-sky-700 focus:text-sky-700 focus-visible:text-sky-700"
                >#[Unique_ID]
              </a>
            </div>
            <div>
              <span
                class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Job Completed on:</span
              >
              <span
                class="font-semibold text-slate-900 hover:!text-slate-900 active:!text-slate-900 hover:text-slate-900 active:text-slate-900 focus:text-slate-900 focus-visible:text-slate-900"
                >[Date_Completed]</span
              >
            </div>
          </div>

          <div
            data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
            data-var-jobid="[jobid]"
            data-entity="peterpm"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-bill-approved="[Bill_Approved_Admin]"
            class="flex flex-wrap items-center justify-between gap-3 text-sm text-slate-600 hover:!text-slate-600 active:!text-slate-600 hover:text-slate-600 active:text-slate-600 focus:text-slate-600 focus-visible:text-slate-600"
          >
            <div class="flex items-center gap-2">
              <span
                class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Xero Bill Status:</span
              >
              <span
                class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-semibold hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs"
                :class="statusPillClass"
                >[Xero_Bill_Status]</span
              >
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <span
                class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Bill Xero ID:</span
              >
              <span
                class="font-mono text-slate-900 hover:!text-slate-900 active:!text-slate-900 hover:text-slate-900 active:text-slate-900 focus:text-slate-900 focus-visible:text-slate-900"
                >[Bill_Xero_ID]</span
              >
            </div>
          </div>

          <div
            data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
            data-var-jobid="[jobid]"
            data-entity="peterpm"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-bill-approved="[Bill_Approved_Admin]"
            class="!grid gap-4 text-sm text-slate-700 md:grid-cols-2 hover:!text-slate-700 active:!text-slate-700 hover:text-slate-700 active:text-slate-700 focus:text-slate-700 focus-visible:text-slate-700"
          >
            <div
              class="rounded-xl border border-slate-200 p-4 hover:!border-slate-200 active:!border-slate-200 hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200"
            >
              <div class="flex items-center justify-between">
                <p
                  class="text-xs uppercase tracking-wide text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >
                  Bill From
                </p>
              </div>
              <div class="mt-3 space-y-2">
                <div class="flex items-center justify-between text-sm">
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >Account Name</span
                  >
                  <span class="font-semibold"
                    >[Primary_Service_Provider_Account_Name]</span
                  >
                </div>
                <div class="grid gap-3 text-sm md:grid-cols-2">
                  <span>
                    <span
                      class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >Account #</span
                    >
                    <p class="font-semibold">
                      [Primary_Service_Provider_Account_Number]
                    </p>
                  </span>
                  <span>
                    <span
                      class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >BSB</span
                    >
                    <p class="font-semibold">[Primary_Service_Provider_BSB]</p>
                  </span>
                  <span>
                    <span
                      class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >Job Rate</span
                    >
                    <p class="font-semibold">
                      [Primary_Service_Provider_Job_Rate_Percentage]%
                    </p>
                  </span>
                  <span>
                    <span
                      class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >ABN</span
                    >
                    <p class="font-semibold">[Primary_Service_Provider_ABN]</p>
                  </span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >GST Registered</span
                  >
                  <span
                    class="font-semibold"
                    x-text="formatBoolean(summary.from.gstRegistered)"
                  ></span>
                </div>
              </div>
            </div>

            <div
              class="rounded-xl border border-slate-200 p-4 hover:!border-slate-200 active:!border-slate-200 hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
              >
                Bill To
              </p>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >Business Name</span
                  >
                  <span
                    class="font-semibold"
                    x-text="summary.to.businessName"
                  ></span>
                </div>
                <div class="flex items-center justify-between">
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >Client Name</span
                  >
                  <span
                    class="font-semibold"
                    x-text="summary.to.clientName"
                  ></span>
                </div>
                <div class="flex items-center justify-between">
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >ABN</span
                  >
                  <span class="font-semibold" x-text="summary.to.abn"></span>
                </div>
                <div>
                  <span
                    class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                    >Address</span
                  >
                  <p class="font-semibold" x-text="summary.to.address"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Details -->
          <div class="space-y-4">
            <details
              class="group overflow-hidden rounded-xl border border-slate-200"
              open
            >
              <summary
                class="flex cursor-pointer items-center justify-between px-4 py-3 text-sm hover:bg-slate-50"
              >
                <span class="font-semibold text-slate-900">Items</span>
                <svg
                  class="h-4 w-4 text-slate-400 transition group-open:rotate-180"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3.5 5.25L7 8.75L10.5 5.25"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </summary>
              <div class="border-t border-slate-200 px-4 py-4">
                <div
                  class="grid grid-cols-2 text-xs font-semibold uppercase tracking-wide text-slate-500"
                >
                  <span>Item</span>
                  <span class="text-right">Total Price</span>
                </div>
                <div
                  class="mt-2 divide-y divide-slate-100 text-sm"
                  data-dynamic-list="q9I5lS0sRQ_WeiZHhxCgC"
                  data-var-jobid="[jobid]"
                  data-entity="peterpm"
                  data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
                >
                  <div class="grid grid-cols-2 py-2">
                    <span>[Service_Service_Name]</span>
                    <span class="text-right">$[Activity_Price]</span>
                  </div>
                </div>
              </div>
            </details>

            <details
              class="group overflow-hidden rounded-xl border border-slate-200"
              open
            >
              <summary
                class="flex cursor-pointer items-center justify-between px-4 py-3 text-sm hover:bg-slate-50"
              >
                <span class="font-semibold text-slate-900">Materials</span>
                <svg
                  class="h-4 w-4 text-slate-400 transition group-open:rotate-180"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3.5 5.25L7 8.75L10.5 5.25"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </summary>
              <div class="border-t border-slate-200 px-4 py-4">
                <div
                  class="grid grid-cols-3 text-xs font-semibold uppercase tracking-wide text-slate-500"
                >
                  <span>Material</span>
                  <span>Transaction Type</span>
                  <span class="text-right">Total Price</span>
                </div>
                <div
                  class="mt-2 divide-y divide-slate-100 text-sm"
                  data-dynamic-list="UlfPmd0tNq5T5Xmip1eHT"
                  data-var-jobid="[jobid"
                  data-entity="peterpm"
                  data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
                >
                  <div class="grid grid-cols-3 py-2">
                    <span>[Material_Name]</span>
                    <span>[Transaction_Type]</span>
                    <span class="text-right">$[Total]</span>
                  </div>
                </div>
                <div
                  class="mt-4 space-y-2 border-t border-slate-200 pt-3 text-sm"
                  data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
                  data-var-jobid="[jobid"
                  data-entity="peterpm"
                  data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
                >
                  <div class="flex items-center justify-between">
                    <span class="text-slate-500">Deduct Total</span>
                    <span>$[Deduct_Total]</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-slate-500">Reimburse Total</span>
                    <span>$[Reimburse_Total]</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-slate-500">Materials Total</span>
                    <span class="font-semibold">$[Materials_Total]</span>
                  </div>
                </div>
              </div>
            </details>
          </div>
          <!-- Details -->

          <div
            data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
            data-var-jobid="[jobid"
            data-entity="peterpm"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-bill-approved="[Bill_Approved_Admin]"
            class="rounded-xl border border-slate-200 p-4 text-sm text-slate-700 hover:!border-slate-200 active:!border-slate-200 hover:!text-slate-700 active:!text-slate-700 hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200 hover:text-slate-700 active:text-slate-700 focus:text-slate-700 focus-visible:text-slate-700"
          >
            <div class="flex flex-wrap items-center gap-4">
              <div>
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Batch ID</span
                >
                <p class="font-semibold">[Bill_Batch_ID]</p>
              </div>
              <div>
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Bill Date</span
                >
                <p class="font-semibold">[Bill_Date]</p>
              </div>
              <div>
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Bill Due Date</span
                >
                <p class="font-semibold">[Bill_Due_Date]</p>
              </div>
            </div>
            <div class="mt-4 space-y-2">
              <div class="flex items-center justify-between">
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Commission Rate</span
                >
                <span class="font-semibold"
                  >[Primary_Service_Provider_Job_Rate_Percentage]%</span
                >
              </div>
              <div class="flex items-center justify-between">
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Bill Total</span
                >
                <span class="font-semibold">$[Bill_Total]</span>
              </div>
              <div class="flex items-center justify-between">
                <span
                  class="text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Bill GST</span
                >
                <span class="font-semibold">$[Bill_GST]</span>
              </div>
              <div
                class="flex items-center justify-between border-t border-slate-200 pt-3 text-base font-semibold text-emerald-600 hover:!border-slate-200 active:!border-slate-200 hover:!text-emerald-600 active:!text-emerald-600 hover:border-t active:border-t focus:border-t focus-visible:border-t hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200 hover:text-emerald-600 active:text-emerald-600 focus:text-emerald-600 focus-visible:text-emerald-600"
              >
                <span>Grand Total (Including GST)</span>
                <span>$[Bill_Total]</span>
              </div>
            </div>
          </div>

          <div
            data-dynamic-list="Cb4DAkWPDzXZATnSGiq-M"
            data-var-jobid="[jobid"
            data-entity="peterpm"
            data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
            data-bill-approved="[Bill_Approved_Admin]"
          >
            <label
              class="flex items-start gap-2 text-sm text-slate-700 hover:!text-slate-700 active:!text-slate-700 hover:text-slate-700 active:text-slate-700 focus:text-slate-700 focus-visible:text-slate-700"
              data-print-exclude
            >
              <span class="hidden" data-bill-approved-value
                >[Bill_Approved_Admin]</span
              >
              <input
                type="checkbox"
                class="mt-1 h-4 w-4 rounded border-slate-300 text-sky-700 focus:ring-sky-500 hover:!border-slate-300 active:!border-slate-300 hover:!text-sky-700 active:!text-sky-700 hover:border-slate-300 active:border-slate-300 focus:border-slate-300 focus-visible:border-slate-300 hover:text-sky-700 active:text-sky-700 focus:text-sky-700 focus-visible:text-sky-700"
                x-model="confirm"
                @change="handleConfirmChange($event)"
                :disabled="confirmBusy"
              />
              <span>I confirm and accept the details of this bill.</span>
              <span class="text-xs text-slate-400" x-show="confirmBusy" x-cloak
                >Saving…</span
              >
            </label>
          </div>
        </div>

        <div
          class="sticky bottom-0 flex items-center justify-end gap-3 border-t border-slate-200 px-6 py-4 bg-white hover:!border-slate-200 active:!border-slate-200 hover:border-t active:border-t focus:border-t focus-visible:border-t hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200 shrink-0"
          data-print-exclude
        >
          <button
            class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 focus:border focus-visible:border focus:border-slate-300 focus-visible:border-slate-300 focus:text-sm focus-visible:text-sm focus:text-slate-700 focus-visible:text-slate-700"
            @click="close"
          >
            Close
          </button>
          <button
            type="button"
            class="rounded-md bg-[#003882] px-4 py-2 text-sm font-semibold text-white disabled:opacity-60 focus:bg-[#003882] focus-visible:bg-[#003882] focus:text-sm focus-visible:text-sm focus:text-white focus-visible:text-white"
            @click="handlePrint"
          >
            Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="followUpCommentModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div
        class="w-full max-w-lg overflow-hidden rounded-sm bg-white shadow-2xl"
      >
        <div
          class="flex items-center justify-between border-b border-slate-200 px-5 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">
            Edit Follow Up Comment
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="space-y-2 px-5 py-4">
          <label
            class="text-sm font-medium text-slate-700"
            for="follow-up-comment-textarea"
            >Follow Up Comment</label
          >
          <textarea
            id="follow-up-comment-textarea"
            class="h-32 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
            x-model="comment"
            placeholder="Enter follow up comment..."
          ></textarea>
        </div>

        <div
          class="flex items-center justify-end gap-4 border-t border-slate-200 px-5 py-4 text-sm"
        >
          <button class="text-slate-500 hover:text-slate-700" @click="close">
            Cancel
          </button>
          <button
            class="rounded bg-sky-800 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-900 disabled:opacity-60"
            @click="handleSave"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 inline h-4 w-4 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                stroke-width="4"
                d="M4 12a8 8 0 0 1 8-8"
              ></path>
            </svg>
            <span>Save</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="sendInvoiceModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div
        class="w-full max-w-lg overflow-hidden rounded-sm bg-white shadow-2xl"
      >
        <div
          class="flex items-center justify-between border-b border-slate-200 px-5 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">
            Send Invoice To:
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close</span>
            <svg
              class="h-5 w-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="px-5 py-4">
          <p class="text-sm text-slate-600">Invoice will be sent to:</p>
          <ul class="mt-4 divide-y divide-slate-100">
            <template x-for="recipient in recipients" :key="recipient.email">
              <li class="flex items-center justify-between gap-3 py-3">
                <div>
                  <div
                    class="flex items-center gap-2 text-sm font-semibold text-slate-900"
                  >
                    <span x-text="recipient.name || recipient.email"></span>
                    <span
                      class="text-xs font-medium text-slate-500"
                      x-text="recipient.role"
                    ></span>
                  </div>
                  <div
                    class="text-xs text-slate-500"
                    x-text="recipient.email"
                  ></div>
                  <div
                    class="text-xs text-slate-500"
                    x-text="recipient.phone || ''"
                  ></div>
                </div>
              </li>
            </template>
          </ul>
        </div>
        <div
          class="flex items-center justify-end gap-3 border-t border-slate-200 px-5 py-4"
        >
          <button
            class="text-sm text-slate-500 hover:text-slate-700"
            @click="close"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center gap-2 rounded-md bg-sky-800 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-900 disabled:opacity-60"
            @click="handleSend"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                stroke-width="4"
                d="M4 12a8 8 0 0 1 8-8"
              ></path>
            </svg>
            <span>Send Invoice</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-data="clientJobTasksModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/40 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div
        class="w-full max-w-3xl overflow-hidden rounded-sm bg-white shadow-2xl"
      >
        <div
          class="flex items-center justify-between bg-[#003882] px-6 py-4 text-white"
        >
          <div class="text-lg font-semibold">Tasks</div>
          <button class="text-white/80 hover:text-white" @click="close">
            <span class="sr-only">Close</span>
            <svg
              class="h-5 w-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="max-h-[70vh] overflow-y-auto divide-y divide-slate-100">
          <template x-for="task in tasks" :key="task.id">
            <div class="flex items-center justify-between gap-3 px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="rounded-full bg-emerald-50 p-1.5 text-emerald-600">
                  <svg
                    class="h-5 w-5"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.8"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
                <div>
                  <p
                    class="text-sm font-semibold text-slate-900"
                    x-text="task.title"
                  ></p>
                  <p
                    class="text-sm text-slate-600"
                    x-text="task.description"
                  ></p>
                </div>
              </div>
              <span
                class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-0.5 text-xs font-semibold text-emerald-700"
                x-text="task.status"
              ></span>
            </div>
          </template>
          <div
            class="px-6 py-10 text-center text-sm text-slate-500"
            x-show="!tasks.length"
          >
            No tasks to display.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-data="editQuoteModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="closeModal"
    >
      <div class="w-full max-w-2xl rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-center justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">Edit Quote</div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="closeModal"
          >
            <span class="sr-only">Close modal</span>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path
                d="M5 5L15 15M15 5L5 15"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>

        <div class="space-y-5 px-6 py-6 text-sm text-slate-700">
          <div
            class="grid gap-4 sm:grid-cols-2"
            x-show="allowDateEditing"
            x-cloak
          >
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Quote Date</span
              >
              <div class="relative">
                <div class="customInputTextWrapper">
                  <input type="date" class="w-full" x-model="form.quoteDate" />
                  <svg
                    class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"
                    width="18"
                    height="18"
                    viewBox="0 0 18 18"
                    fill="none"
                  >
                    <path
                      d="M13.5 3.83331H4.5C4.10218 3.83331 3.72064 3.99135 3.43934 4.27265C3.15804 4.55395 3 4.93549 3 5.33331V13.5C3 13.8978 3.15804 14.2793 3.43934 14.5606C3.72064 14.8419 4.10218 15 4.5 15H13.5C13.8978 15 14.2794 14.8419 14.5607 14.5606C14.842 14.2793 15 13.8978 15 13.5V5.33331C15 4.93549 14.842 4.55395 14.5607 4.27265C14.2794 3.99135 13.8978 3.83331 13.5 3.83331Z"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M11.25 2.16669V5.33335"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M6.75 2.16669V5.33335"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M3 8.5H15"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </label>
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Follow Up Date</span
              >
              <div class="relative customInputTextWrapper">
                <input type="date" class="w-full" x-model="form.followUpDate" />
                <svg
                  class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  fill="none"
                >
                  <path
                    d="M13.5 3.83331H4.5C4.10218 3.83331 3.72064 3.99135 3.43934 4.27265C3.15804 4.55395 3 4.93549 3 5.33331V13.5C3 13.8978 3.15804 14.2793 3.43934 14.5606C3.72064 14.8419 4.10218 15 4.5 15H13.5C13.8978 15 14.2794 14.8419 14.5607 14.5606C14.842 14.2793 15 13.8978 15 13.5V5.33331C15 4.93549 14.842 4.55395 14.5607 4.27265C14.2794 3.99135 13.8978 3.83331 13.5 3.83331Z"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M11.25 2.16669V5.33335"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M6.75 2.16669V5.33335"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M3 8.5H15"
                    stroke="currentColor"
                    stroke-width="1.2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
            </label>
          </div>

          <div class="space-y-3">
            <div
              class="rounded-lg border-2 border-dashed border-slate-200 bg-slate-50 px-6 py-10 text-center text-slate-600"
              @click="triggerFileInput"
            >
              <input
                type="file"
                multiple
                class="sr-only"
                x-ref="fileInput"
                @change="handleFiles"
              />
              <svg
                width="40"
                height="40"
                viewBox="0 0 40 40"
                class="mx-auto mb-4 text-slate-400"
                fill="none"
              >
                <path
                  d="M20 10V30M10 20H30"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <p class="text-sm font-semibold text-sky-700">
                Click to upload
                <span class="font-normal text-slate-600">or drag and drop</span>
              </p>
              <p class="text-xs text-slate-500">
                SVG, PNG, JPG or GIF (max 800×400px)
              </p>
            </div>

            <div class="space-y-2" x-show="attachments.length">
              <template x-for="file in attachments" :key="file.id">
                <div
                  class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm"
                >
                  <div class="flex items-center gap-3">
                    <template x-if="file.url">
                      <a
                        :href="file.url"
                        target="_blank"
                        rel="noopener"
                        class="inline-flex items-center gap-2 text-sky-700 hover:text-sky-900"
                      >
                        <svg
                          width="18"
                          height="18"
                          viewBox="0 0 18 18"
                          fill="none"
                        >
                          <path
                            d="M12.75 9C12.75 10.5188 11.5188 11.75 10 11.75C8.48122 11.75 7.25 10.5188 7.25 9C7.25 7.48122 8.48122 6.25 10 6.25C11.5188 6.25 12.75 7.48122 12.75 9Z"
                            stroke="currentColor"
                            stroke-width="1.2"
                          />
                          <path
                            d="M15.1667 9C15.1667 12.1816 12.515 14.8333 9.33331 14.8333C6.15165 14.8333 3.49998 12.1816 3.49998 9C3.49998 5.81834 6.15165 3.16667 9.33331 3.16667C12.515 3.16667 15.1667 5.81834 15.1667 9Z"
                            stroke="currentColor"
                            stroke-width="1.2"
                          />
                        </svg>
                        <span class="font-medium" x-text="file.name"></span>
                      </a>
                    </template>
                    <template x-if="!file.url">
                      <div class="flex items-center gap-2 text-slate-500">
                        <svg
                          width="18"
                          height="18"
                          viewBox="0 0 18 18"
                          fill="none"
                        >
                          <path
                            d="M12.75 9C12.75 10.5188 11.5188 11.75 10 11.75C8.48122 11.75 7.25 10.5188 7.25 9C7.25 7.48122 8.48122 6.25 10 6.25C11.5188 6.25 12.75 7.48122 12.75 9Z"
                            stroke="currentColor"
                            stroke-width="1.2"
                          />
                          <path
                            d="M15.1667 9C15.1667 12.1816 12.515 14.8333 9.33331 14.8333C6.15165 14.8333 3.49998 12.1816 3.49998 9C3.49998 5.81834 6.15165 3.16667 9.33331 3.16667C12.515 3.16667 15.1667 5.81834 15.1667 9Z"
                            stroke="currentColor"
                            stroke-width="1.2"
                          />
                        </svg>
                        <span
                          class="font-medium text-slate-800"
                          x-text="file.name"
                        ></span>
                      </div>
                    </template>
                    <span
                      class="text-xs text-slate-500"
                      x-text="file.kind || 'Attachment'"
                    ></span>
                  </div>
                  <button
                    class="text-slate-400 transition hover:text-rose-600"
                    @click.prevent="removeAttachment(file.id)"
                    x-show="!file.existing"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path
                        d="M3.5 4.5H12.5M6 4.5V3.5C6 3.10218 6.15804 2.72064 6.43934 2.43934C6.72064 2.15804 7.10218 2 7.5 2H9.5C9.89782 2 10.2794 2.15804 10.5607 2.43934C10.842 2.72064 11 3.10218 11 3.5V4.5M12 4.5V12.5C12 12.8978 11.842 13.2794 11.5607 13.5607C11.2794 13.842 10.8978 14 10.5 14H6.5C6.10218 14 5.72064 13.842 5.43934 13.5607C5.15804 13.2794 5 12.8978 5 12.5V4.5H12Z"
                        stroke="currentColor"
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>
              </template>
            </div>
          </div>
        </div>

        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 hover:text-slate-700"
            @click="closeModal"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center gap-2 rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleSave"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 h-4 w-4 animate-spin text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span x-text="isSubmitting ? 'Saving…' : 'Save'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Comment Modal -->
  <div x-data="popupCommentModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="handleClose"
    >
      <div class="w-full max-w-lg bg-white shadow-2xl" x-transition>
        <div
          class="flex items-start justify-between border-b border-slate-200 px-6 py-4"
        >
          <div>
            <div class="text-lg font-semibold">Note to consider</div>
            <p class="mt-1 text-sm text-slate-500">
              Add notes if the client has issues
            </p>
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="handleClose"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="px-6 py-5">
          <label
            class="mb-2 block text-sm font-medium text-slate-600"
            for="popup-comment-textarea"
          >
            Add notes if the client has issues
          </label>
          <textarea
            id="popup-comment-textarea"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
            rows="4"
            placeholder="Enter popup comment..."
            x-model="comment"
          ></textarea>
        </div>

        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 transition hover:text-slate-700"
            @click="handleClose"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleUpdate"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span>Update</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Uploads Modal -->
  <div x-data="uploadsModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/70 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div class="relative w-full max-w-4xl rounded-sm bg-white shadow-2xl">
        <button
          class="absolute right-4 top-4 rounded-full p-1 text-slate-500 hover:bg-slate-100 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-200"
          @click="close()"
        >
          <span class="sr-only">Close modal</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div class="px-6 pt-6 pb-4">
          <div class="text-lg font-semibold text-slate-900">
            Resident Photos & Files
          </div>
        </div>
        <div class="px-6 pb-6">
          <div
            class="relative overflow-hidden rounded-2xl border border-slate-200 bg-slate-50"
          >
            <template x-if="!attachments.length">
              <div class="p-10 text-center text-sm text-slate-500">
                No attachments available.
              </div>
            </template>
            <template x-if="attachments.length">
              <div class="relative">
                <div
                  class="flex items-center justify-between px-4 pt-4 text-sm text-slate-600"
                >
                  <span x-text="currentAttachment.name || 'Attachment'"></span>
                  <span x-text="attachmentLabel"></span>
                </div>
                <div
                  class="mx-auto flex h-96 w-full max-w-3xl items-center justify-center p-6"
                >
                  <template x-if="currentAttachment.isImage">
                    <img
                      x-bind:src="currentAttachment.url"
                      x-bind:alt="currentAttachment.name || 'Attachment'"
                      class="max-h-full max-w-full rounded-lg shadow"
                    />
                  </template>
                  <template x-if="!currentAttachment.isImage">
                    <div
                      class="flex flex-col items-center gap-4 rounded-xl border border-dashed border-slate-300 bg-white p-8 text-center shadow-inner"
                    >
                      <div class="rounded-full bg-slate-100 p-4 text-slate-600">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-10 w-10"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            d="M8 2a2 2 0 00-2 2v1H3.5A1.5 1.5 0 002 6.5v9A1.5 1.5 0 003.5 17h13a1.5 1.5 0 001.5-1.5v-9A1.5 1.5 0 0016.5 5H14V4a2 2 0 00-2-2H8zm4 3H8V4h4v1z"
                          />
                        </svg>
                      </div>
                      <div
                        class="text-base font-semibold text-slate-700"
                        x-text="currentAttachment.name"
                      ></div>
                      <div
                        class="text-sm text-slate-500"
                        x-text="currentAttachment.typeLabel"
                      ></div>
                      <a
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
                        :href="currentAttachment.url"
                        target="_blank"
                        rel="noopener"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            d="M12.293 2.293a1 1 0 011.414 0l4 4a.997.997 0 01.083 1.32l-.083.094-4 4a1 1 0 01-1.497-1.32l.083-.094L14.585 9H9a5 5 0 00-4.995 4.783L4 14a1 1 0 01-1.993.117L2 14a7 7 0 016.824-6.995L9 7h5.585l-1.292-1.293a1 1 0 01-.083-1.32l.083-.094z"
                          />
                          <path
                            d="M5 3a1 1 0 01.993.883L6 4v1a1 1 0 01-1.993.117L4 5V4a1 1 0 011-1zM2 9a1 1 0 01.993.883L3 10v5a1 1 0 01-1.993.117L1 15v-5a1 1 0 011-1zm12 5a1 1 0 01.993.883L15 15v1a1 1 0 01-1.993.117L13 16v-1a1 1 0 011-1z"
                          />
                        </svg>
                        <span>Open File</span>
                      </a>
                    </div>
                  </template>
                </div>

                <div class="absolute inset-y-0 left-0 flex items-center">
                  <button
                    class="rounded-full bg-white/80 p-2 text-slate-700 shadow hover:bg-white focus:outline-none focus:ring-2 focus:ring-slate-300 disabled:opacity-30"
                    @click="prev"
                    :disabled="!hasPrev"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>
                <div class="absolute inset-y-0 right-0 flex items-center">
                  <button
                    class="rounded-full bg-white/80 p-2 text-slate-700 shadow hover:bg-white focus:outline-none focus:ring-2 focus:ring-slate-300 disabled:opacity-30"
                    @click="next"
                    :disabled="!hasNext"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M7.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L10.586 10 7.293 6.707a1 1 0 010-1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inquiry Uploads Dynamic List -->
  <div
    data-dynamic-list="bdDNg3pCpjPMq5xV-blpe"
    data-entity="peterpm"
    data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
    data-var-inquiryid="[inquiryid]"
    data-upload-source="resident-feedback"
    class="!hidden"
  >
    <div data-upload-sources class="!hidden" aria-hidden="true">
      <div data-photo-uploads-slot data-type="[Type]">[Photo_Upload]</div>
      <div data-file-uploads-slot data-type="[Type]">[File_Upload]</div>
    </div>
  </div>

  <!-- Job Uploads Dynamic List -->
  <div
    data-dynamic-list="l0slrYt3DxbQQcUDXr6LV"
    data-entity="peterpm"
    data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
    data-var-jobid="[jobid]"
    data-upload-source="edit-quote"
    data-op="subscribe"
    class="!hidden"
  >
    <div data-upload-sources class="!hidden" aria-hidden="true">
      <div data-photo-uploads-slot data-type="[Type]">[Photo_Upload]</div>
      <div data-file-uploads-slot data-type="[Type]">[File_Upload]</div>
    </div>
  </div>

  <!-- Recommendation Modal -->
  <div x-data="recommendationModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div class="w-full max-w-lg rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-start justify-between border-b border-slate-200 px-6 py-4"
        >
          <div>
            <div class="text-lg font-semibold">Recommendation</div>
            <p class="mt-1 text-sm text-slate-500">
              Update the admin recommendation for this job.
            </p>
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="px-6 py-5">
          <label
            class="mb-2 block text-sm font-medium text-slate-600"
            for="recommendation-textarea"
          >
            Admin Recommendation
          </label>
          <textarea
            id="recommendation-textarea"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
            rows="4"
            placeholder="Enter recommendation..."
            x-model="value"
          ></textarea>
        </div>
        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 transition hover:text-slate-700"
            @click="close"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="submit"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span>Update</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Activity Modal -->
  <div x-data="activityModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="handleClose"
    >
      <div class="w-full max-w-3xl rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-center justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">Add Activity</div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="handleClose"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-5 px-6 py-6 text-sm text-slate-700">
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Job</span
              >
              <div class="relative">
                <select
                  class="customSelect"
                  x-model="form.job"
                  x-ref="jobSelect"
                >
                  <option value="Job 1">Job 1</option>
                  <option value="Job 2">Job 2</option>
                  <option value="Job 3">Job 3</option>
                  <option value="Job 4">Job 4</option>
                </select>
                <span
                  class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.23 7.21a.75.75 0 011.06.02L10 11.175l3.71-3.944a.75.75 0 011.08 1.04l-4.25 4.518a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </span>
              </div>
            </label>
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Options</span
              >
              <div class="relative">
                <select
                  class="customSelect"
                  x-model="form.option"
                  x-ref="optionSelect"
                >
                  <option value="Option 1">Option 1</option>
                  <option value="Option 2">Option 2</option>
                  <option value="Option 3">Option 3</option>
                  <option value="Option 4">Option 4</option>
                </select>
                <span
                  class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.23 7.21a.75.75 0 011.06.02L10 11.175l3.71-3.944a.75.75 0 011.08 1.04l-4.25 4.518a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </span>
              </div>
            </label>
          </div>
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Service</span
              >
              <div class="relative">
                <select
                  class="customSelect"
                  x-model="form.service"
                  @change="handleServiceChange"
                >
                  <template x-if="!services.length">
                    <option value="">Select a service</option>
                  </template>
                  <template x-for="service in services" :key="service.id">
                    <option :value="service.id" x-text="service.name"></option>
                  </template>
                </select>
                <span
                  class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.23 7.21a.75.75 0 011.06.02L10 11.175l3.71-3.944a.75.75 0 011.08 1.04l-4.25 4.518a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </span>
                <div class="hidden" x-ref="serviceSource" aria-hidden="true">
                  <div
                    data-dynamic-list="kA10GF11bcrHMQd3omol7"
                    data-entity="peterpm"
                    data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
                  >
                    <option
                      value="[serviceid]"
                      data-service-name="[Service_Name]"
                      data-service-type="[Service_Type]"
                      data-parent-service="[Primary_Service_ID]"
                      data-warranty-text = "[Standard_Warranty]"
                      data-description = "[Service_Description]"
                      data-price = "[Service_Price]"
                    >
                      [Service_Name]
                    </option>
                  </div>
                </div>
              </div>
            </label>
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Activity Price</span
              >
              <div class="relative">
                <div class="customInputTextWrapper !flex items-center gap-2">
                  <span class="text-slate-500">$</span>
                  <input
                    type="number"
                    class="w-full min-w-0"
                    placeholder="0.00"
                    x-model="form.activityPrice"
                    min="0"
                    step="0.01"
                  />
                </div>
              </div>
            </label>
          </div>
          <label
            class="space-y-1 block"
            x-show="filteredServiceOptions.length"
            x-cloak
          >
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Service Options</span
            >
            <div class="relative">
              <select
                class="customSelect"
                x-model="form.serviceOption"
                @change="handleServiceOptionChange"
              >
                <template
                  x-for="option in filteredServiceOptions"
                  :key="option.id"
                >
                  <option :value="option.id" x-text="option.name"></option>
                </template>
              </select>
              <span
                class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-slate-400"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.175l3.71-3.944a.75.75 0 011.08 1.04l-4.25 4.518a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </span>
              <div
                class="hidden"
                x-ref="serviceOptionSource"
                aria-hidden="true"
              >
                <div
                  data-dynamic-list="vjs6nalZ9ILutT1ab23L2"
                  data-entity="peterpm"
                  data-entity-key="1rBR-jpR3yE3HE1VhFD0j"
                >
                  <option
                    value="[serviceid]"
                    data-parent-service="[Primary_Service_ID]"
                    data-service-name="[Service_Name]"
                    data-warranty-text = "[Standard_Warranty]"
                    data-description = "[Service_Description]"
                    data-price = "[Service_Price]"
                  >
                    [Service_Name]
                  </option>
                </div>
              </div>
            </div>
          </label>
          <label class="space-y-1 block">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Activity Text</span
            >
            <textarea
              class="w-full resize-y rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
              rows="3"
              x-model="form.activityText"
            ></textarea>
          </label>
          <label class="space-y-1 block">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Warranty</span
            >
            <textarea
              class="w-full resize-y rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
              rows="2"
              x-model="form.warranty"
            ></textarea>
          </label>
          <label class="space-y-1 block">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Note</span
            >
            <textarea
              class="w-full resize-y rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
              rows="2"
              x-model="form.note"
            ></textarea>
          </label>
          <div class="space-y-2 text-sm text-slate-600">
            <label class="flex items-center gap-2">
              <input
                type="checkbox"
                class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                x-model="form.invoiceClient"
              />
              <span>Invoice to client</span>
            </label>
            <label class="flex items-center gap-2">
              <input
                type="checkbox"
                class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                x-model="form.includeInQuoteSubtotal"
              />
              <span>Include in Quote Subtotal</span>
            </label>
          </div>
        </div>
        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 transition hover:text-slate-700"
            @click="handleClose"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleSubmit"
            :disabled="isSubmitting || !form.service || (filteredServiceOptions.length && !form.serviceOption)"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span>Add</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Activity Modal -->
  <div x-data="deleteActivityModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="close"
    >
      <div class="w-full max-w-md rounded-sm bg-white shadow-2xl">
        <div
          class="flex items-start justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">
            Delete Activity
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="close"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="px-6 py-5 text-sm text-slate-600">
          <p class="font-medium text-slate-800">
            You are about to delete this activity.
          </p>
          <p class="mt-2">
            This action cannot be undone. Do you want to proceed?
          </p>
        </div>
        <div
          class="flex items-center justify-between border-t border-slate-200 px-6 py-4 text-sm"
        >
          <button
            class="font-medium text-slate-500 transition hover:text-slate-700"
            @click="close"
            :disabled="isSubmitting"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-rose-700 disabled:cursor-not-allowed disabled:bg-rose-300"
            @click="confirm"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 mr-2 h-4 w-4 animate-spin"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span>Delete</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Deal Info Modal -->
  <div x-data="dealInfoModal()" x-cloak>
    <div
      class="fixed inset-0 z-40 flex min-h-screen items-center justify-center bg-slate-900/50 px-4 py-10 text-slate-800"
      x-show="open"
      x-transition.opacity
      @keydown.escape.window="handleClose"
    >
      <div class="w-full max-w-2xl bg-white shadow-2xl rounded-sm">
        <!-- Header -->
        <div
          class="flex items-center justify-between border-b border-slate-200 px-6 py-4"
        >
          <div class="text-lg font-semibold text-slate-900">
            Deal Information
          </div>
          <button
            class="text-slate-400 transition hover:text-slate-600"
            @click="handleClose"
          >
            <span class="sr-only">Close modal</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Body -->
        <div class="space-y-5 px-6 py-6 text-sm text-slate-700">
          <!-- Deal Name -->
          <label class="space-y-1 block">
            <span class="text-xs font-semibold uppercase text-slate-500">
              Deal Name
            </span>
            <div class="customInputTextWrapperDisabled">
              <input
                type="text"
                class="w-full"
                x-model="form.dealName"
                readonly
              />
            </div>
          </label>

          <!-- Deal Value / Sales Stage -->
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500">
                Deal Value
              </span>
              <div class="customInputTextWrapper">
                <input type="text" class="w-full" x-model="form.dealValue" />
              </div>
            </label>

            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500">
                Sales Stage
              </span>
              <div class="relative">
                <select class="w-full customSelect" x-model="form.salesStage">
                  <option value="">Select</option>
                  <template x-for="stage in salesStageOptions" :key="stage">
                    <option :value="stage" x-text="stage"></option>
                  </template>
                </select>
                <span
                  class="pointer-events-none absolute inset-y-0 right-3 inline-flex items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-slate-400"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </span>
              </div>
            </label>
          </div>

          <!-- Expected Win % / Expected Close Date / Actual Close Date -->
          <div class="grid gap-4 sm:grid-cols-3">
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500">
                Expected Win Percentage
              </span>
              <div class="customInputTextWrapper">
                <input
                  type="text"
                  class="w-full"
                  x-model="form.expectedWinPercentage"
                  placeholder="0"
                />
              </div>
            </label>

            <!-- Expected Close Date (date only) -->
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Expected Close Date</span
              >
              <div class="relative">
                <div class="customInputTextWrapper">
                  <input
                    type="date"
                    class="w-full"
                    x-model="form.expectedCloseDate"
                  />
                </div>
              </div>
            </label>

            <!-- Actual Close Date (date only) -->
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500"
                >Actual Close Date</span
              >
              <div class="relative">
                <div class="customInputTextWrapper">
                  <input
                    type="date"
                    class="w-full"
                    x-model="form.actualCloseDate"
                  />
                </div>
              </div>
            </label>
          </div>

          <!-- Weighted Value / Recent Activity -->
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500">
                Weighted Value
              </span>
              <div class="customInputTextWrapper">
                <input
                  type="text"
                  class="w-full"
                  x-model="form.weightedValue"
                />
              </div>
            </label>

            <label class="space-y-1">
              <span class="text-xs font-semibold uppercase text-slate-500">
                Recent Activity
              </span>
              <div class="relative">
                <select class="customSelect" x-model="form.recentActivity">
                  <option value="">Select</option>
                  <template
                    x-for="activity in recentActivityOptions"
                    :key="activity"
                  >
                    <option :value="activity" x-text="activity"></option>
                  </template>
                </select>
                <span
                  class="pointer-events-none absolute inset-y-0 right-3 inline-flex items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-slate-400"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </span>
              </div>
            </label>
          </div>
        </div>

        <!-- Footer -->
        <div
          class="flex items-center justify-end gap-3 border-t border-slate-200 bg-slate-50 px-6 py-4"
        >
          <button
            type="button"
            class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100"
            @click="handleClose"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center gap-2 rounded-lg bg-sky-700 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-800 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
            @click="handleSave"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="-ml-1 h-4 w-4 animate-spin text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
            <span x-text="isSubmitting ? 'Saving…' : 'Save'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div x-data="addTaskModal" x-cloak>
    <!-- Backdrop -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 bg-black/40 z-40"
      @click="handleClose()"
    ></div>

    <!-- Dialog -->
    <div
      x-show="open"
      x-transition
      class="fixed inset-0 z-50 grid place-items-center p-4"
      @keydown.escape.window="handleClose()"
    >
      <div class="w-full max-w-md rounded-sm bg-white shadow-xl">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b">
          <div class="text-lg font-semibold">
            Add Task to [jobid]
          </div>
          <button
            class="text-slate-500 hover:text-slate-700"
            @click="handleClose()"
          >
            &times;
          </button>
        </div>

        <!-- Body -->
        <div class="px-5 py-4 space-y-4">
          <!-- Subject -->
          <label class="block space-y-1">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Subject</span
            >
            <div class="customInputTextWrapper">
              <input type="text" x-model.trim="form.subject" class="w-full" />
            </div>
          </label>

          <!-- Assignee -->
          <div class="space-y-1">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Assignee</span
            >
            <div class="customInputTextWrapper">
              <input
                type="text"
                x-model.trim="form.assigneeName"
                placeholder="Search or type a name"
                class="w-full"
              />
            </div>
            <button
              type="button"
              class="text-sky-700 text-sm hover:underline"
              @click="assignToMe()"
            >
              Assign to me
            </button>
          </div>

          <!-- Due Date (date only) -->
          <label class="block space-y-1">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Due Date/Time</span
            >
            <div class="relative customInputTextWrapper">
              <input
                type="text"
                :value="form.dueDate ? form.dueDate.split('-').reverse().join('/') : ''"
                placeholder="dd/mm/yy"
                readonly
                class="w-full cursor-pointer"
              />
              <span
                class="pointer-events-none absolute inset-y-0 right-3 inline-flex items-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 text-slate-400"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M8 7V5m8 2V5M5 9h14M5 19h14a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2z"
                  />
                </svg>
              </span>
              <!-- actual calendar (overlay so popover anchors correctly) -->
              <input
                type="date"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                @input="handlePickDate($event)"
                x-ref="dueDateNative"
              />
            </div>
          </label>

          <!-- Notes -->
          <label class="block space-y-1">
            <span class="text-xs font-semibold uppercase text-slate-500"
              >Notes</span
            >
            <textarea
              x-model.trim="form.notes"
              rows="4"
              class="w-full rounded border border-slate-300 bg-white px-3 py-2 text-sm focus:border-sky-600 focus:ring-1 focus:ring-sky-500 focus:outline-none"
            ></textarea>
          </label>

          <template x-if="error">
            <p class="text-sm text-red-600" x-text="error"></p>
          </template>
        </div>

        <!-- Footer -->
        <div class="flex items-center justify-between px-5 py-4 border-t">
          <button
            class="text-slate-600 hover:text-slate-800"
            @click="handleClose()"
            :disabled="isSubmitting"
          >
            Cancel
          </button>
          <button
            class="inline-flex items-center gap-2 rounded bg-sky-800 text-white px-4 py-2 hover:bg-sky-900 disabled:opacity-60"
            @click="handleSave()"
            :disabled="isSubmitting"
          >
            <template x-if="!isSubmitting"
              ><span>Add Task & Notify</span></template
            >
            <template x-if="isSubmitting">
              <span class="inline-flex items-center gap-2">
                <svg
                  class="h-4 w-4 animate-spin"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    stroke-width="4"
                    d="M4 12a8 8 0 0 1 8-8"
                  ></path>
                </svg>
                Saving…
              </span>
            </template>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Task Modal -->

  <!-- Task List Modal -->
  <div x-data="taskListModal" x-cloak>
    <!-- Backdrop -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 bg-black/40 z-40"
      @click="handleClose()"
    ></div>

    <!-- Dialog -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 z-50 grid place-items-center p-4"
      @keydown.escape.window="handleClose()"
    >
      <div class="w-full max-w-3xl rounded-sm bg-white shadow-xl">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b">
          <div class="text-lg font-semibold">
            Task List for [jobid]
          </div>
          <button
            class="text-slate-500 hover:text-slate-700"
            @click="handleClose()"
          >
            &times;
          </button>
        </div>

        <!-- Body -->
        <div class="px-4 py-4">
          <template x-if="error">
            <p class="text-sm text-red-600 mb-3" x-text="error"></p>
          </template>

          <template x-if="isLoading">
            <div class="flex items-center gap-3 text-slate-500 p-4">
              <svg
                class="h-5 w-5 animate-spin"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  stroke-width="4"
                  d="M4 12a8 8 0 0 1 8-8"
                ></path>
              </svg>
              Loading tasks…
            </div>
          </template>

          <div class="space-y-4" x-show="!isLoading">
            <template x-for="task in tasks" :key="task.uid">
              <div class="rounded-lg border border-slate-200 p-4">
                <div class="flex items-start justify-between">
                  <div class="flex items-center gap-2">
                    <span
                      class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
                      :class="pillClass(task.status)"
                      x-text="pillText(task.status)"
                    ></span>
                  </div>

                  <!-- Row right-side controls (scoped popovers) -->
                  <div
                    class="text-sm text-slate-600 flex flex-col items-end gap-2"
                    x-data="taskRowPopovers(task, assignees)"
                  >
                    <!-- Assignee + Reassign -->
                    <div class="relative flex items-center gap-1">
                      <span class="font-medium">Assignee:</span>
                      <span x-text="task.assigneeName"></span>
                      <span class="text-slate-400" x-show="task.assigneeEmail"
                        >(<span x-text="task.assigneeEmail"></span>)</span
                      >
                      <button
                        type="button"
                        class="p-1 rounded outline outline-1 outline-offset-[-1px] outline-gray-300 inline-flex items-center hover:bg-slate-50"
                        @click.stop="reassignOpen = !reassignOpen"
                        title="Reassign"
                        aria-label="Reassign"
                      >
                        <svg
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <g clip-path="url(#clip0_8687_22430)">
                            <path
                              d="M19.2749 6.6969C18.153 5.15641 16.5714 4.01122 14.7573 3.42737C12.9434 2.84356 10.9909 2.85103 9.18115 3.44788C7.41997 4.0288 5.88372 5.14026 4.77881 6.62659C5.88358 5.14078 7.41948 4.02972 9.18018 3.44885C10.99 2.85183 12.9432 2.84457 14.7573 3.42834C16.5712 4.01211 18.153 5.1567 19.2749 6.6969ZM19.2749 6.6969C20.3967 8.23737 21.0005 10.094 20.9995 11.9996C21.0003 10.0942 20.3967 8.23715 19.2749 6.6969ZM17.6704 18.9879C16.8267 19.6726 15.8614 20.2042 14.8169 20.5485C13.7904 20.8868 12.7179 21.0342 11.6509 20.9928C11.7672 20.9972 11.8837 20.9998 12.0005 20.9996C13.9969 20.997 15.9362 20.3321 17.5142 19.109L17.6704 18.9879ZM11.5024 20.985C11.4298 20.981 11.3572 20.9761 11.2847 20.9703C11.3572 20.9761 11.4297 20.981 11.5024 20.985ZM11.1401 20.9567C11.0711 20.95 11.002 20.9444 10.9331 20.9362C11.0019 20.9443 11.071 20.9501 11.1401 20.9567ZM10.6519 20.8971C10.6405 20.8954 10.6291 20.894 10.6177 20.8922C10.629 20.894 10.6405 20.8954 10.6519 20.8971ZM10.3345 20.8434C10.3019 20.8373 10.2693 20.8313 10.2368 20.8248C10.2693 20.8313 10.3019 20.8373 10.3345 20.8434ZM9.99561 20.7731C9.96043 20.765 9.92523 20.7571 9.89014 20.7487C9.92522 20.7571 9.96041 20.765 9.99561 20.7731ZM9.65674 20.6881C9.61543 20.677 9.5739 20.6666 9.53271 20.6549C9.57387 20.6667 9.61541 20.677 9.65674 20.6881ZM9.32178 20.5914C9.29554 20.5833 9.26886 20.5764 9.24268 20.568C9.21644 20.5596 9.19068 20.5493 9.16455 20.5406C9.21682 20.558 9.26919 20.575 9.32178 20.5914ZM8.99365 20.4821C8.93809 20.4624 8.88273 20.4423 8.82764 20.4215C8.88276 20.4423 8.93813 20.4623 8.99365 20.4821ZM8.65479 20.3541C8.59362 20.3296 8.5327 20.3047 8.47217 20.2789C8.53273 20.3048 8.59369 20.3296 8.65479 20.3541ZM8.33643 20.2194C8.2672 20.1885 8.19872 20.1562 8.13037 20.1237C8.19875 20.1563 8.26729 20.1885 8.33643 20.2194ZM8.00439 20.0621C7.94448 20.0324 7.88487 20.0023 7.82568 19.9713C7.88488 20.0024 7.94456 20.0324 8.00439 20.0621ZM7.0835 19.5367C6.82295 19.3668 6.57117 19.184 6.32959 18.9879L6.48389 19.108C6.67834 19.2595 6.87851 19.4026 7.0835 19.5367ZM6.31299 18.1129L5.95654 18.6676C5.94971 18.6614 5.94285 18.6553 5.93604 18.649L6.45264 17.902C6.48063 17.8614 6.50975 17.8217 6.53857 17.7819C6.46028 17.8897 6.385 18.0003 6.31299 18.1129ZM13.2983 14.9957L14.5063 15.4772C15.7379 15.9679 16.7971 16.8123 17.5493 17.9039L18.062 18.649C18.0552 18.6553 18.0483 18.6614 18.0415 18.6676L17.687 18.1129C17.0766 17.1583 16.2355 16.3719 15.2417 15.8278C14.2518 15.2858 13.1416 15.0009 12.0132 14.9987C12.7502 14.9961 13.4705 14.7774 14.0835 14.3678C14.1322 14.3352 14.1781 14.299 14.2251 14.2643L13.2983 14.9957ZM4.09717 16.3053C4.42248 16.9008 4.81665 17.4616 5.2749 17.9752L5.45166 18.1735C5.19286 17.8989 4.95004 17.6078 4.72607 17.3004C4.49377 16.9816 4.28432 16.6489 4.09717 16.3053ZM18.6919 18.0153C18.6701 18.0395 18.6494 18.0646 18.6274 18.0885L18.6919 18.0153ZM18.9946 17.6598C18.9111 17.763 18.8256 17.8643 18.7378 17.9635C18.8258 17.8643 18.911 17.7627 18.9946 17.6598ZM9.79736 14.2838C10.4287 14.7422 11.1913 14.9947 11.981 14.9987C10.8545 15.0018 9.74653 15.2867 8.7583 15.8278C7.89626 16.2998 7.14915 16.9538 6.56787 17.7418C7.31148 16.7293 8.32428 15.9434 9.49365 15.4772L10.7007 14.9957L9.79736 14.2838ZM19.2915 17.276C19.2136 17.3836 19.1326 17.4886 19.0503 17.5924C19.1329 17.4887 19.2134 17.3833 19.2915 17.276ZM3.88037 15.8785C3.8445 15.8034 3.80962 15.728 3.77588 15.652C3.8097 15.728 3.84444 15.8035 3.88037 15.8785ZM3.7085 15.4977C3.67982 15.4297 3.65247 15.3612 3.62549 15.2926C3.65252 15.3612 3.67977 15.4297 3.7085 15.4977ZM3.5708 15.1549C3.5315 15.0499 3.49482 14.9439 3.45947 14.8375C3.49488 14.9439 3.53143 15.0499 3.5708 15.1549ZM3.44775 14.8043C3.40778 14.6824 3.37018 14.5597 3.33545 14.4362C3.37023 14.5597 3.40773 14.6824 3.44775 14.8043ZM23.2505 11.9996V12.0006L21.0005 14.2506L22.2808 12.9694L23.2495 11.9996H23.2505ZM3.271 14.1852C3.2625 14.1513 3.25273 14.1176 3.24463 14.0836C3.25273 14.1177 3.2625 14.1513 3.271 14.1852ZM3.18213 13.7975C3.17728 13.7737 3.17213 13.75 3.16748 13.7262C3.17213 13.75 3.17728 13.7737 3.18213 13.7975ZM3.12549 13.4928C3.11642 13.4389 3.10819 13.3848 3.1001 13.3307C3.10818 13.3848 3.11642 13.4389 3.12549 13.4928ZM19.7192 12.9694L20.0464 13.2975L18.7495 11.9996L19.7192 12.9694ZM3.0708 13.1207C3.06314 13.0596 3.05671 12.9984 3.05029 12.9371C3.05669 12.9984 3.06315 13.0597 3.0708 13.1207ZM5.25049 11.9996L5.24951 12.0006L5.25049 11.9996ZM3.03174 12.7506C3.02473 12.6668 3.0198 12.5828 3.01514 12.4987C3.01976 12.5828 3.02477 12.6668 3.03174 12.7506ZM15.5171 12.5426C15.5102 12.5613 15.5028 12.5797 15.4956 12.5983C15.5028 12.5797 15.5102 12.5613 15.5171 12.5426ZM15.5981 12.3004C15.5973 12.3034 15.5961 12.3062 15.5952 12.3092C15.5982 12.2992 15.6002 12.289 15.603 12.2789C15.6011 12.2858 15.6002 12.2936 15.5981 12.3004ZM15.6763 11.9781C15.6717 12.0013 15.6667 12.0244 15.6616 12.0475C15.6667 12.0244 15.6717 12.0013 15.6763 11.9781ZM15.7212 11.691C15.7176 11.7214 15.7138 11.7516 15.7095 11.7819C15.7138 11.7516 15.7176 11.7214 15.7212 11.691ZM8.28369 11.7418C8.28239 11.7321 8.28101 11.7223 8.27979 11.7125C8.281 11.7223 8.2824 11.7321 8.28369 11.7418ZM15.7446 11.3971C15.7431 11.4349 15.7405 11.4726 15.7378 11.5104C15.7404 11.4726 15.7431 11.4349 15.7446 11.3971ZM15.7456 11.1041C15.7472 11.1458 15.7474 11.1874 15.7476 11.2291C15.7473 11.1875 15.7472 11.1458 15.7456 11.1041ZM8.25146 11.1871C8.25209 11.147 8.25444 11.1071 8.25635 11.067C8.25439 11.107 8.25214 11.147 8.25146 11.1871ZM15.7241 10.8199C15.7298 10.8693 15.7331 10.9188 15.7368 10.9684C15.7331 10.9189 15.7298 10.8694 15.7241 10.8199ZM8.26611 10.9156C8.27058 10.8651 8.27619 10.8147 8.28271 10.7643C8.27614 10.8146 8.27065 10.865 8.26611 10.9156ZM15.6831 10.5485C15.6904 10.587 15.6956 10.6259 15.7017 10.6647C15.6955 10.626 15.6905 10.5871 15.6831 10.5485ZM8.29932 10.649C8.309 10.5889 8.31989 10.529 8.33252 10.4694C8.31984 10.5289 8.30909 10.5889 8.29932 10.649ZM8.35303 10.3824C8.36985 10.3114 8.38864 10.2408 8.40967 10.1705C8.38861 10.2406 8.36996 10.3113 8.35303 10.3824ZM15.6157 10.2594C15.6269 10.3002 15.6363 10.3414 15.646 10.3824C15.6362 10.3413 15.6269 10.3001 15.6157 10.2594ZM11.9995 7.49573C12.7789 7.49573 13.5393 7.73819 14.1743 8.19006C14.8093 8.64203 15.2882 9.28082 15.5435 10.0172C15.5609 10.0676 15.5741 10.1196 15.5894 10.1705C15.4114 9.57889 15.0913 9.03776 14.6519 8.59827C14.1275 8.07391 13.4592 7.71664 12.7319 7.5719C12.0045 7.4272 11.2502 7.50194 10.5649 7.78577C9.8798 8.06957 9.29436 8.55004 8.88232 9.16663C8.78619 9.3105 8.70035 9.46037 8.62549 9.61487C8.89895 9.04894 9.30983 8.55726 9.82568 8.19006C10.4605 7.73831 11.2203 7.49581 11.9995 7.49573ZM8.42725 10.1149C8.43745 10.0826 8.44545 10.0492 8.45654 10.0172C8.46834 9.98319 8.48287 9.95022 8.49561 9.91663C8.47073 9.982 8.44842 10.0482 8.42725 10.1149ZM8.51904 9.85608C8.54391 9.79377 8.57006 9.7322 8.59814 9.67151C8.56994 9.73228 8.54391 9.79397 8.51904 9.85608ZM7.68115 19.8942C7.58938 19.844 7.49858 19.7922 7.40869 19.7389C7.49861 19.7924 7.58956 19.8439 7.68115 19.8942ZM7.39502 19.7301C7.29601 19.6711 7.19769 19.6112 7.10107 19.5485C7.19771 19.6114 7.29624 19.6711 7.39502 19.7301ZM4.09619 16.3024C4.04003 16.1992 3.98608 16.095 3.93408 15.9899C3.9862 16.095 4.03993 16.1993 4.09619 16.3024Z"
                              fill="black"
                              stroke="#0052CC"
                              stroke-width="1.5"
                            />
                          </g>
                          <defs>
                            <clipPath id="clip0_8687_22430">
                              <rect width="24" height="24" fill="white" />
                            </clipPath>
                          </defs>
                        </svg>
                      </button>

                      <!-- Reassign popover -->
                      <div
                        x-show="reassignOpen"
                        x-transition.opacity
                        @click.outside="reassignOpen=false"
                        class="absolute right-0 top-full mt-2 z-50 w-64 bg-white rounded-lg shadow-lg border border-slate-200"
                      >
                        <div class="py-2 max-h-64 overflow-auto">
                          <template x-for="user in assignees" :key="user.id">
                            <button
                              type="button"
                              class="w-full text-left px-3 py-2 hover:bg-slate-50 flex items-center justify-between"
                              :class="{'bg-sky-50': tempAssigneeId === user.id}"
                              @click="tempAssigneeId = user.id"
                            >
                              <span class="truncate" x-text="user.name"></span>
                              <span x-show="tempAssigneeId === user.id">✓</span>
                            </button>
                          </template>
                        </div>
                        <div
                          class="flex items-center justify-between px-3 py-2 border-t"
                        >
                          <button
                            class="text-slate-600 hover:text-slate-800"
                            @click="reassignOpen=false"
                            :disabled="savingReassign"
                          >
                            Cancel
                          </button>
                          <button
                            class="inline-flex items-center gap-2 rounded bg-sky-800 text-white px-3 py-2 hover:bg-sky-900 disabled:opacity-60"
                            @click="confirmReassign()"
                            :disabled="savingReassign"
                          >
                            <svg
                              x-show="savingReassign"
                              class="h-4 w-4 animate-spin"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                            >
                              <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke-width="4"
                              ></circle>
                              <path
                                class="opacity-75"
                                stroke-width="4"
                                d="M4 12a8 8 0 0 1 8-8"
                              ></path>
                            </svg>
                            <span>Reassign</span>
                            <span x-show="!savingReassign">✓</span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Due + Reschedule -->
                    <div class="relative flex items-center gap-1">
                      <span class="font-medium">Due:</span>
                      <span x-text="humanDue(task.dueISO)"></span>
                      <button
                        type="button"
                        class="p-1 rounded outline outline-1 outline-offset-[-1px] outline-gray-300 inline-flex items-center hover:bg-slate-50"
                        @click.stop="reschedOpen = !reschedOpen"
                        title="Reschedule"
                        aria-label="Reschedule"
                      >
                        <svg
                          width="20"
                          height="20"
                          viewBox="0 0 20 20"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M9.75 5.75V9.75L12.75 12.75M0.973 11.75C1.34948 13.4018 2.18453 14.9138 3.38212 16.1121C4.57971 17.3104 6.0912 18.1463 7.74276 18.5238C9.39433 18.9012 11.1189 18.8049 12.7181 18.2458C14.3174 17.6867 15.7263 16.6875 16.783 15.3633C17.8396 14.039 18.501 12.4434 18.6911 10.76C18.8812 9.07652 18.5923 7.3736 17.8576 5.84704C17.123 4.32049 15.9723 3.03229 14.5381 2.13061C13.1038 1.22893 11.4441 0.750384 9.75 0.75C7.97986 0.749521 6.24889 1.27105 4.77364 2.24933C3.29839 3.22761 2.14439 4.6192 1.456 6.25M4.75 6.75H0.75V2.75"
                            stroke="#0052CC"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </button>

                      <!-- Reschedule popover -->
                      <div
                        x-show="reschedOpen"
                        x-transition.opacity
                        @click.outside="reschedOpen=false"
                        class="absolute right-0 top-full mt-2 z-50 w-72 bg-white rounded-lg shadow-lg border border-slate-200 p-3"
                      >
                        <div class="mb-3">
                          <input
                            type="date"
                            x-model="tempDue"
                            class="w-full rounded border border-slate-300 bg-white px-3 py-2 text-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500"
                          />
                        </div>
                        <div class="flex items-center justify-between">
                          <button
                            class="text-slate-600 hover:text-slate-800"
                            @click="reschedOpen=false"
                            :disabled="savingResched"
                          >
                            Cancel
                          </button>
                          <button
                            class="inline-flex items-center gap-2 rounded bg-sky-800 text-white px-3 py-2 hover:bg-sky-900 disabled:opacity-60"
                            @click="confirmReschedule()"
                            :disabled="savingResched"
                          >
                            <svg
                              x-show="savingResched"
                              class="h-4 w-4 animate-spin"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                            >
                              <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke-width="4"
                              ></circle>
                              <path
                                class="opacity-75"
                                stroke-width="4"
                                d="M4 12a8 8 0 0 1 8-8"
                              ></path>
                            </svg>
                            <span>Reschedule</span>
                            <span x-show="!savingResched">✓</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <h4
                  class="mt-3 text-lg font-semibold"
                  x-text="task.subject"
                ></h4>
                <p class="mt-2 text-slate-700" x-text="task.notes"></p>

                <ul class="mt-3 list-disc pl-5 text-slate-700 space-y-1">
                  <template x-for="b in task.bullets">
                    <li x-text="b"></li>
                  </template>
                </ul>

                <hr class="my-4" />

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-5 text-sky-700">
                    <a
                      :href="mailtoLink(task)"
                      x-show="task.assigneeEmail"
                      @click.stop
                      class="hover:underline"
                      :title="`Email ${task.assigneeName || task.assigneeEmail}`"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                      >
                        <path d="M4 6h16v12H4z" stroke-width="1.5"></path>
                        <path d="M4 7l8 6 8-6" stroke-width="1.5"></path>
                      </svg>
                    </a>
                    <span class="w-px h-5 bg-slate-200"></span>
                  </div>

                  <div>
                    <template x-if="task.status !== 'Completed'">
                      <button
                        type="button"
                        class="rounded border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50 disabled:opacity-60 cursor-pointer"
                        @click="handleMarkComplete(task)"
                        :disabled="isBusy(task)"
                      >
                        <span x-show="!actionLoading[task.uid]"
                          >Mark As Complete</span
                        >
                        <span
                          x-show="actionLoading[task.uid]"
                          class="inline-flex items-center gap-2"
                        >
                          <svg
                            class="h-4 w-4 animate-spin"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <circle
                              class="opacity-25"
                              cx="12"
                              cy="12"
                              r="10"
                              stroke-width="4"
                            ></circle>
                            <path
                              class="opacity-75"
                              stroke-width="4"
                              d="M4 12a8 8 0 0 1 8-8"
                            ></path>
                          </svg>
                          Saving…
                        </span>
                      </button>
                    </template>

                    <template x-if="task.status === 'Completed'">
                      <button
                        class="rounded border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50 disabled:opacity-60"
                        @click="reopen(task)"
                        :disabled="actionLoading[task.uid]"
                      >
                        <span x-show="!actionLoading[task.uid]">Reopen</span>
                        <span
                          x-show="actionLoading[task.uid]"
                          class="inline-flex items-center gap-2"
                        >
                          <svg
                            class="h-4 w-4 animate-spin"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <circle
                              class="opacity-25"
                              cx="12"
                              cy="12"
                              r="10"
                              stroke-width="4"
                            ></circle>
                            <path
                              class="opacity-75"
                              stroke-width="4"
                              d="M4 12a8 8 0 0 1 8-8"
                            ></path>
                          </svg>
                          Saving…
                        </span>
                      </button>
                    </template>
                  </div>
                </div>
              </div>
            </template>

            <div x-show="!tasks.length && !error" class="text-slate-500 p-4">
              No tasks yet.
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex items-center justify-end px-5 py-4 border-t">
          <button
            class="text-slate-600 hover:text-slate-800"
            @click="handleClose()"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- /Task List Modal -->

  <!-- Add Property Contact Modal -->
  <div x-data="propertyContactModal" x-cloak>
    <!-- Backdrop -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 bg-black/40 z-40 hover:!bg-black/40 active:!bg-black/40 hover:bg-black/40 active:bg-black/40 focus:bg-black/40 focus-visible:bg-black/40"
      @click="handleClose()"
    ></div>

    <!-- Dialog -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 z-50 grid place-items-center p-4"
      @keydown.escape.window="handleClose()"
      x-trap.noscroll="open"
    >
      <div
        class="w-full max-w-lg rounded-lg bg-white shadow-xl hover:!bg-white active:!bg-white hover:bg-white active:bg-white focus:bg-white focus-visible:bg-white hover:shadow-xl active:shadow-xl focus:shadow-xl focus-visible:shadow-xl"
      >
        <!-- Header -->
        <div
          class="flex items-center justify-between px-5 py-4 border-b hover:border-b active:border-b focus:border-b focus-visible:border-b"
        >
          <div
            class="text-lg font-semibold"
            x-text="isEdit ? 'Edit Property Contact' : 'Add Property Contact'"
          ></div>
          <button
            class="text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
            @click="handleClose()"
            aria-label="Close"
          >
            &times;
          </button>
        </div>

        <!-- Body -->
        <div class="px-5 py-4 space-y-4">
          <template x-if="error">
            <p
              class="text-sm text-red-600 hover:!text-red-600 active:!text-red-600 hover:text-red-600 active:text-red-600 focus:text-red-600 focus-visible:text-red-600"
              x-text="error"
            ></p>
          </template>

          <div class="flex items-center gap-2">
            <button
              type="button"
              class="rounded-full border px-3 py-1 text-xs font-semibold uppercase tracking-wide transition"
              :class="contactType === 'contact' ? 'border-sky-600 text-sky-700 bg-sky-50' : 'border-slate-200 text-slate-500'"
              @click="contactType = 'contact'"
            >
              Contact
            </button>
            <button
              type="button"
              class="rounded-full border px-3 py-1 text-xs font-semibold uppercase tracking-wide transition"
              :class="contactType === 'company' ? 'border-sky-600 text-sky-700 bg-sky-50' : 'border-slate-200 text-slate-500'"
              @click="contactType = 'company'"
            >
              Company
            </button>
          </div>

          <div x-show="contactType === 'contact'" x-cloak class="space-y-3">
            <!-- Contact search -->
            <label class="block">
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Contact</span
              >
              <div
                class="relative mt-1"
                @keydown.escape.stop.prevent="closeSearchDropdown"
              >
                <button
                  type="button"
                  class="flex w-full items-center justify-between rounded-lg border border-slate-300 bg-white px-3 py-2 text-left text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border focus-visible:border focus:border-slate-300 focus-visible:border-slate-300 focus:bg-white focus-visible:bg-white focus:text-left focus-visible:text-left focus:text-sm focus-visible:text-sm focus:text-slate-800 focus-visible:text-slate-800 focus:shadow-sm focus-visible:shadow-sm"
                  @click="toggleSearchDropdown"
                  :aria-expanded="searchDropdownOpen"
                >
                  <span
                    class="truncate"
                    x-text="form.search || 'Search existing contacts or add a new one'"
                  ></span>
                  <span class="flex items-center gap-2">
                    <span
                      x-show="form.contactId"
                      class="text-slate-400 focus:text-slate-400 focus-visible:text-slate-400"
                      role="button"
                      tabindex="0"
                      @click.stop="clearSelectedContact"
                      @keydown.enter.prevent.stop="clearSelectedContact"
                    >
                      <svg
                        class="h-4 w-4"
                        viewBox="0 0 14 14"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5"
                          stroke="currentColor"
                          stroke-width="1.4"
                          stroke-linecap="round"
                        />
                      </svg>
                    </span>
                    <svg
                      class="h-4 w-4 text-slate-500 transition focus:text-slate-500 focus-visible:text-slate-500"
                      :class="searchDropdownOpen ? 'rotate-180' : ''"
                      viewBox="0 0 14 14"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M3.5 5.25L7 8.75L10.5 5.25"
                        stroke="currentColor"
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>

                <div
                  x-show="searchDropdownOpen"
                  x-transition
                  x-cloak
                  @click.outside="closeSearchDropdown"
                  class="absolute z-20 mt-1 w-full rounded-xl border border-slate-200 bg-white shadow-2xl hover:!border-slate-200 active:!border-slate-200 hover:!bg-white active:!bg-white hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200 hover:bg-white active:bg-white focus:bg-white focus-visible:bg-white hover:shadow-2xl active:shadow-2xl focus:shadow-2xl focus-visible:shadow-2xl"
                >
                  <div
                    class="border-b border-slate-100 px-3 py-2 hover:!border-slate-100 active:!border-slate-100 hover:border-b active:border-b focus:border-b focus-visible:border-b hover:border-slate-100 active:border-slate-100 focus:border-slate-100 focus-visible:border-slate-100"
                  >
                    <input
                      x-ref="contactSearchInput"
                      type="text"
                      autocomplete="off"
                      placeholder="Type a name, email, or phone number"
                      class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500 hover:!border-slate-200 active:!border-slate-200 hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200"
                      x-model="searchTerm"
                      @input.debounce.250ms="onSearchChange"
                    />
                  </div>
                  <div
                    class="max-h-60 overflow-y-auto divide-y divide-slate-100"
                  >
                    <template x-if="searchLoading">
                      <div
                        class="px-3 py-4 text-sm text-slate-500 flex items-center gap-2 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        <svg
                          class="h-4 w-4 animate-spin text-slate-400 hover:!text-slate-400 active:!text-slate-400 hover:text-slate-400 active:text-slate-400 focus:text-slate-400 focus-visible:text-slate-400"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke-width="4"
                          ></circle>
                          <path
                            class="opacity-75"
                            stroke-width="4"
                            d="M4 12a8 8 0 0 1 8-8"
                          ></path>
                        </svg>
                        <span>Searching contacts...</span>
                      </div>
                    </template>
                    <template x-if="!searchLoading && suggestions.length">
                      <div>
                        <template
                          x-for="contact in suggestions"
                          :key="contact.id || contact.email"
                        >
                          <button
                            type="button"
                            class="w-full px-3 py-3 text-left focus:text-left focus-visible:text-left"
                            @click="pickSuggestion(contact)"
                          >
                            <div class="flex flex-col gap-0.5">
                              <span
                                class="text-sm font-semibold text-slate-900 focus:text-sm focus-visible:text-sm focus:text-slate-900 focus-visible:text-slate-900"
                                x-text="contact.displayLabel"
                              ></span>
                              <span
                                class="text-xs text-slate-500 focus:text-xs focus-visible:text-xs focus:text-slate-500 focus-visible:text-slate-500"
                                x-text="contact.email"
                              ></span>
                              <span
                                class="text-xs text-slate-500 focus:text-xs focus-visible:text-xs focus:text-slate-500 focus-visible:text-slate-500"
                                x-show="contact.sms"
                                x-text="contact.sms"
                              ></span>
                            </div>
                          </button>
                        </template>
                      </div>
                    </template>
                    <template
                      x-if="!searchLoading && hasSearched && !suggestions.length && !searchError"
                    >
                      <p
                        class="px-3 py-4 text-sm text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        No contacts found.
                      </p>
                    </template>
                    <template
                      x-if="!searchLoading && !hasSearched && !searchError"
                    >
                      <p
                        class="px-3 py-4 text-sm text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        Start typing to search existing contacts.
                      </p>
                    </template>
                    <template x-if="searchError">
                      <p
                        class="px-3 py-4 text-sm text-rose-600 hover:!text-rose-600 active:!text-rose-600 hover:text-rose-600 active:text-rose-600 focus:text-rose-600 focus-visible:text-rose-600"
                        x-text="searchError"
                      ></p>
                    </template>
                  </div>
                  <button
                    type="button"
                    class="w-full border-t border-slate-100 px-3 py-2 text-left text-sm font-medium text-sky-700 focus:border-t focus-visible:border-t focus:border-slate-100 focus-visible:border-slate-100 focus:text-left focus-visible:text-left focus:text-sm focus-visible:text-sm focus:text-sky-700 focus-visible:text-sky-700"
                    @click="clearSelectedContact"
                  >
                    Clear selection
                  </button>
                </div>
              </div>
            </label>

            <!-- Role -->
            <label class="block" x-show="showRoleField" x-cloak>
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Role
                <span
                  class="text-red-500 hover:!text-red-500 active:!text-red-500 hover:text-red-500 active:text-red-500 focus:text-red-500 focus-visible:text-red-500"
                  >*</span
                ></span
              >
              <div class="customInputTextWrapper">
                <input type="text" class="w-full" x-model="form.role" />
              </div>
            </label>

            <!-- Names -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >First Name
                  <span
                    class="text-red-500 hover:!text-red-500 active:!text-red-500 hover:text-red-500 active:text-red-500 focus:text-red-500 focus-visible:text-red-500"
                    >*</span
                  ></span
                >
                <div class="customInputTextWrapper">
                  <input type="text" class="w-full" x-model="form.firstName" />
                </div>
              </label>
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Last Name</span
                >
                <div class="customInputTextWrapper">
                  <input type="text" class="w-full" x-model="form.lastName" />
                </div>
              </label>
            </div>

            <!-- Email / SMS -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Email
                  <span
                    class="text-red-500 hover:!text-red-500 active:!text-red-500 hover:text-red-500 active:text-red-500 focus:text-red-500 focus-visible:text-red-500"
                    >*</span
                  ></span
                >
                <div class="customInputTextWrapper">
                  <input type="text" class="w-full" x-model="form.email" />
                </div>
              </label>
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >SMS Number</span
                >
                <div class="customInputTextWrapper">
                  <input type="text" class="w-full" x-model="form.sms" />
                </div>
              </label>
            </div>

            <!-- Primary -->
            <label
              class="inline-flex items-center gap-2"
              x-show="showPrimaryToggle"
              x-cloak
            >
              <input
                type="checkbox"
                x-model="form.isPrimary"
                class="h-4 w-4 rounded border-slate-300 text-sky-700 focus:ring-sky-500 hover:!border-slate-300 active:!border-slate-300 hover:!text-sky-700 active:!text-sky-700 hover:border-slate-300 active:border-slate-300 focus:border-slate-300 focus-visible:border-slate-300 hover:text-sky-700 active:text-sky-700 focus:text-sky-700 focus-visible:text-sky-700"
              />
              <span
                class="text-sm text-slate-700 hover:!text-slate-700 active:!text-slate-700 hover:text-slate-700 active:text-slate-700 focus:text-slate-700 focus-visible:text-slate-700"
                >Is Primary Contact</span
              >
            </label>
          </div>

          <div x-show="contactType === 'company'" x-cloak class="space-y-3">
            <!-- Company search -->
            <label class="block">
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Company</span
              >
              <div
                class="relative mt-1"
                @keydown.escape.stop.prevent="closeCompanySearch"
              >
                <button
                  type="button"
                  class="flex w-full items-center justify-between rounded-lg border border-slate-300 bg-white px-3 py-2 text-left text-sm text-slate-800 shadow-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border focus-visible:border focus:border-slate-300 focus-visible:border-slate-300 focus:bg-white focus-visible:bg-white focus:text-left focus-visible:text-left focus:text-sm focus-visible:text-sm focus:text-slate-800 focus-visible:text-slate-800 focus:shadow-sm focus-visible:shadow-sm"
                  @click="companySearchOpen ? closeCompanySearch() : openCompanySearch()"
                  :aria-expanded="companySearchOpen"
                >
                  <span
                    class="truncate"
                    x-text="companyForm.search || 'Search companies or add a new one'"
                  ></span>
                  <span class="flex items-center gap-2">
                    <span
                      x-show="companyForm.companyId"
                      class="text-slate-400 focus:text-slate-400 focus-visible:text-slate-400"
                      role="button"
                      tabindex="0"
                      @click.stop="clearSelectedCompany"
                      @keydown.enter.prevent.stop="clearSelectedCompany"
                    >
                      <svg
                        class="h-4 w-4"
                        viewBox="0 0 14 14"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5"
                          stroke="currentColor"
                          stroke-width="1.4"
                          stroke-linecap="round"
                        />
                      </svg>
                    </span>
                    <svg
                      class="h-4 w-4 text-slate-500 transition focus:text-slate-500 focus-visible:text-slate-500"
                      :class="companySearchOpen ? 'rotate-180' : ''"
                      viewBox="0 0 14 14"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M3.5 5.25L7 8.75L10.5 5.25"
                        stroke="currentColor"
                        stroke-width="1.2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </span>
                </button>
                <div
                  x-show="companySearchOpen"
                  x-transition
                  x-cloak
                  @click.outside="closeCompanySearch"
                  class="absolute z-20 mt-1 w-full rounded-xl border border-slate-200 bg-white shadow-2xl hover:!border-slate-200 active:!border-slate-200 hover:!bg-white active:!bg-white hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200 hover:bg-white active:bg-white focus:bg-white focus-visible:bg-white hover:shadow-2xl active:shadow-2xl focus:shadow-2xl focus-visible:shadow-2xl"
                >
                  <div
                    class="border-b border-slate-100 px-3 py-2 hover:!border-slate-100 active:!border-slate-100 hover:border-b active:border-b focus:border-b focus-visible:border-b hover:border-slate-100 active:border-slate-100 focus:border-slate-100 focus-visible:border-slate-100"
                  >
                    <input
                      type="text"
                      x-model="companyForm.search"
                      placeholder="Type a company name"
                      class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-sky-600 focus:outline-none focus:ring-1 focus:ring-sky-500 hover:!border-slate-200 active:!border-slate-200 hover:border active:border focus:border focus-visible:border hover:border-slate-200 active:border-slate-200 focus:border-slate-200 focus-visible:border-slate-200"
                      @input.debounce.250ms="onCompanySearchChange"
                    />
                  </div>
                  <div
                    class="max-h-60 overflow-y-auto divide-y divide-slate-100"
                  >
                    <template x-if="companySearchLoading">
                      <div
                        class="px-3 py-4 text-sm text-slate-500 flex items-center gap-2 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        <svg
                          class="h-4 w-4 animate-spin text-slate-400 hover:!text-slate-400 active:!text-slate-400 hover:text-slate-400 active:text-slate-400 focus:text-slate-400 focus-visible:text-slate-400"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke-width="4"
                          ></circle>
                          <path
                            class="opacity-75"
                            stroke-width="4"
                            d="M4 12a8 8 0 0 1 8-8"
                          ></path>
                        </svg>
                        <span>Searching companies...</span>
                      </div>
                    </template>
                    <template
                      x-if="!companySearchLoading && companySuggestions.length"
                    >
                      <div>
                        <template
                          x-for="company in companySuggestions"
                          :key="company.id || company.displayLabel"
                        >
                          <button
                            type="button"
                            class="w-full px-3 py-3 text-left focus:text-left focus-visible:text-left"
                            @click="pickCompanySuggestion(company)"
                          >
                            <div class="flex flex-col gap-0.5">
                              <span
                                class="text-sm font-semibold text-slate-900 focus:text-sm focus-visible:text-sm focus:text-slate-900 focus-visible:text-slate-900"
                                x-text="company.displayLabel"
                              ></span>
                              <span
                                class="text-xs text-slate-500 focus:text-xs focus-visible:text-xs focus:text-slate-500 focus-visible:text-slate-500"
                                x-text="company.address"
                              ></span>
                              <span
                                class="text-xs text-slate-500 focus:text-xs focus-visible:text-xs focus:text-slate-500 focus-visible:text-slate-500"
                                x-text="company.phone"
                              ></span>
                            </div>
                          </button>
                        </template>
                      </div>
                    </template>
                    <template
                      x-if="!companySearchLoading && companyHasSearched && !companySuggestions.length && !companySearchError"
                    >
                      <p
                        class="px-3 py-4 text-sm text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        No companies found.
                      </p>
                    </template>
                    <template
                      x-if="!companySearchLoading && !companyHasSearched && !companySearchError"
                    >
                      <p
                        class="px-3 py-4 text-sm text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                      >
                        Start typing to search companies.
                      </p>
                    </template>
                    <template x-if="companySearchError">
                      <p
                        class="px-3 py-4 text-sm text-rose-600 hover:!text-rose-600 active:!text-rose-600 hover:text-rose-600 active:text-rose-600 focus:text-rose-600 focus-visible:text-rose-600"
                      >
                        <span x-text="companySearchError"></span>
                      </p>
                    </template>
                  </div>
                  <button
                    type="button"
                    class="w-full border-t border-slate-100 px-3 py-2 text-left text-sm font-medium text-sky-700 focus:border-t focus-visible:border-t focus:border-slate-100 focus-visible:border-slate-100 focus:text-left focus-visible:text-left focus:text-sm focus-visible:text-sm focus:text-sky-700 focus-visible:text-sky-700"
                    @click="clearSelectedCompany"
                  >
                    Clear selection
                  </button>
                </div>
              </div>
            </label>

            <!-- Company details -->
            <label class="block">
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Name</span
              >
              <div class="customInputTextWrapper">
                <input type="text" class="w-full" x-model="companyForm.name" />
              </div>
            </label>

            <label class="block">
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Phone</span
              >
              <div class="customInputTextWrapper">
                <input type="text" class="w-full" x-model="companyForm.phone" />
              </div>
            </label>

            <label class="block">
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Address</span
              >
              <div class="customInputTextWrapper">
                <input
                  type="text"
                  class="w-full"
                  x-model="companyForm.address"
                />
              </div>
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >City</span
                >
                <div class="customInputTextWrapper">
                  <input
                    type="text"
                    class="w-full"
                    x-model="companyForm.city"
                  />
                </div>
              </label>
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >State</span
                >
                <div class="customInputTextWrapper">
                  <input
                    type="text"
                    class="w-full"
                    x-model="companyForm.state"
                  />
                </div>
              </label>
              <label class="block">
                <span
                  class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                  >Postal Code</span
                >
                <div class="customInputTextWrapper">
                  <input
                    type="text"
                    class="w-full"
                    x-model="companyForm.postalCode"
                  />
                </div>
              </label>
            </div>

            <!-- Role -->
            <label class="block" x-show="showRoleField" x-cloak>
              <span
                class="text-xs font-semibold uppercase text-slate-500 hover:!text-slate-500 active:!text-slate-500 hover:text-xs active:text-xs focus:text-xs focus-visible:text-xs hover:text-slate-500 active:text-slate-500 focus:text-slate-500 focus-visible:text-slate-500"
                >Role
                <span
                  class="text-red-500 hover:!text-red-500 active:!text-red-500 hover:text-red-500 active:text-red-500 focus:text-red-500 focus-visible:text-red-500"
                  >*</span
                ></span
              >
              <div class="customInputTextWrapper">
                <input type="text" class="w-full" x-model="companyForm.role" />
              </div>
            </label>

            <!-- Primary -->
            <label
              class="inline-flex items-center gap-2"
              x-show="showPrimaryToggle"
              x-cloak
            >
              <input
                type="checkbox"
                x-model="companyForm.isPrimary"
                class="h-4 w-4 rounded border-slate-300 text-sky-700 focus:ring-sky-500 hover:!border-slate-300 active:!border-slate-300 hover:!text-sky-700 active:!text-sky-700 hover:border-slate-300 active:border-slate-300 focus:border-slate-300 focus-visible:border-slate-300 hover:text-sky-700 active:text-sky-700 focus:text-sky-700 focus-visible:text-sky-700"
              />
              <span
                class="text-sm text-slate-700 hover:!text-slate-700 active:!text-slate-700 hover:text-slate-700 active:text-slate-700 focus:text-slate-700 focus-visible:text-slate-700"
                >Is Primary Contact</span
              >
            </label>
          </div>
        </div>

        <!-- Footer -->
        <div
          class="flex items-center justify-end gap-3 px-5 py-4 border-t hover:border-t active:border-t focus:border-t focus-visible:border-t"
        >
          <button
            class="text-slate-600 focus:text-slate-600 focus-visible:text-slate-600"
            @click="handleClose()"
            :disabled="isSubmitting"
          >
            Cancel
          </button>
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded bg-[#003882] text-white px-4 py-2 disabled:opacity-60 focus:bg-[#003882] focus-visible:bg-[#003882] focus:text-white focus-visible:text-white"
            @click="handleSave()"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="h-4 w-4 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                stroke-width="4"
                d="M4 12a8 8 0 0 1 8-8"
              ></path>
            </svg>
            <span x-text="isEdit ? 'Save Changes' : 'Save Contact'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Property Contact Modal -->

  <!-- Delete Property Contact Modal -->
  <div x-data="deleteAffiliationModal" x-cloak>
    <!-- Backdrop -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 bg-black/40 z-40"
      @click="handleClose()"
    ></div>

    <!-- Dialog -->
    <div
      x-show="open"
      x-transition.opacity
      class="fixed inset-0 z-50 grid place-items-center p-4"
      @keydown.escape.window="handleClose()"
      x-trap.noscroll="open"
    >
      <div class="w-full max-w-lg rounded-sm bg-white shadow-xl">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b">
          <div class="text-lg font-semibold">Delete Contact</div>
          <button
            class="text-slate-500 hover:text-slate-700"
            @click="handleClose()"
            aria-label="Close"
          >
            &times;
          </button>
        </div>

        <!-- Body -->
        <div class="px-5 py-4 space-y-4 text-[14px] text-slate-800">
          <p>
            This contact will be permanently removed from the property record.
          </p>
          <p>Do you want to continue?</p>
          <template x-if="error">
            <p class="text-sm text-red-600" x-text="error"></p>
          </template>
        </div>

        <!-- Footer -->
        <div class="flex items-center justify-end gap-3 px-5 py-4 border-t">
          <button
            type="button"
            class="text-slate-600 hover:text-slate-800"
            @click="handleClose()"
            :disabled="isSubmitting"
          >
            Keep Contact
          </button>

          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-md bg-red-600 text-white px-4 py-2 hover:bg-red-700 disabled:opacity-60"
            @click="handleDelete()"
            :disabled="isSubmitting"
          >
            <svg
              x-show="isSubmitting"
              class="h-4 w-4 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                stroke-width="4"
                d="M4 12a8 8 0 0 1 8-8"
              ></path>
            </svg>
            <span>Delete</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Delete Property Contact Modal -->
</div>
<!-- Modals -->
